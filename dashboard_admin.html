<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord Administrateur</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .table th {
            border-top: none;
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="loginSection" class="container mt-5" style="max-width: 400px; display:none;">
        <h2 class="mb-3">Connexion Admin</h2>
        <form id="adminLoginForm">
            <div class="mb-3">
                <label for="loginEmail" class="form-label">Email</label>
                <input type="email" class="form-control" id="loginEmail" required>
            </div>
            <div class="mb-3">
                <label for="loginPassword" class="form-label">Mot de passe</label>
                <input type="password" class="form-control" id="loginPassword" required>
            </div>
            <button type="submit" class="btn btn-primary">Se connecter</button>
        </form>
    </div>

    <div id="dashboardContainer" class="container-fluid" style="display:none;">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 px-0">
                <div class="sidebar d-flex flex-column p-3">
                    <div class="text-center mb-4">
                        <h4 class="text-white">
                            <i class="bi bi-shield-check"></i>
                            Admin Panel
                        </h4>
                    </div>
                    
                    <ul class="nav nav-pills flex-column mb-auto">
                        <li class="nav-item mb-2">
                            <a href="#" class="nav-link active" data-section="home">
                                <i class="bi bi-house-door me-2"></i>
                                Accueil
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a href="#" class="nav-link" data-section="users">
                                <i class="bi bi-people me-2"></i>
                                Utilisateurs
                            </a>
                        </li>
                        <li class="nav-item mb-2" id="agentsNavItem" style="display:none;">
                            <a href="#" class="nav-link" data-section="agents">
                                <i class="bi bi-person-badge me-2"></i>
                                Agents
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a href="#" class="nav-link" data-section="transactions">
                                <i class="bi bi-credit-card me-2"></i>
                                Transactions
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a href="#" class="nav-link" data-section="kyc">
                                <i class="bi bi-person-check me-2"></i>
                                Vérification KYC
                            </a>
                        </li>
                    </ul>
                    
                    <div class="mt-auto">
                        <div class="text-center">
                            <small class="text-white-50">© 2025 Admin Dashboard</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9 col-lg-10">
                <div class="main-content p-4">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">Tableau de Bord</h2>
                        <div class="d-flex align-items-center">
                            <span class="me-3">Bienvenue, Administrateur</span>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-person-circle"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" id="settingsLink"><i class="bi bi-gear me-2"></i>Paramètres</a></li>
                                    <li><a class="dropdown-item" href="#" id="logoutLink"><i class="bi bi-box-arrow-right me-2"></i>Déconnexion</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Home Section -->
                    <div id="home-section" class="content-section active">
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="card stats-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-people fs-1 mb-2"></i>
                                        <h3 id="statTotalUsers" class="mb-1"></h3>
                                        <p class="mb-0">Utilisateurs Total</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card stats-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-credit-card fs-1 mb-2"></i>
                                        <h3 id="statTotalDeposits" class="mb-1"></h3>
                                        <p class="mb-0">Total Dépôts</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card stats-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-stack fs-1 mb-2"></i>
                                        <h3 id="statDepositCount" class="mb-1"></h3>
                                        <p class="mb-0">Nombre de dépôts</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card stats-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-check-circle fs-1 mb-2"></i>
                                        <h3 id="statSuccessRate" class="mb-1"></h3>
                                        <p class="mb-0">Taux de Réussite</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Activité Récente</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="list-group list-group-flush">
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="bi bi-person-plus text-success me-2"></i>
                                                    Nouvel utilisateur inscrit: Marie Dupont
                                                </div>
                                                <small class="text-muted">Il y a 5 min</small>
                                            </div>
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="bi bi-credit-card text-primary me-2"></i>
                                                    Transaction de €1,250 approuvée
                                                </div>
                                                <small class="text-muted">Il y a 12 min</small>
                                            </div>
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="bi bi-check-circle text-success me-2"></i>
                                                    KYC approuvé pour Jean Martin
                                                </div>
                                                <small class="text-muted">Il y a 1 heure</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Actions Rapides</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-primary" data-section="users">
                                                <i class="bi bi-person-plus me-2"></i>
                                                Créer Utilisateur
                                            </button>
                                            <button class="btn btn-primary" id="createAgentQuickBtn" style="display:none;" data-bs-toggle="modal" data-bs-target="#createAgentModal">
                                                <i class="bi bi-person-badge me-2"></i>
                                                Créer Agent
                                            </button>
                                            <button class="btn btn-outline-primary" data-section="kyc">
                                                <i class="bi bi-person-check me-2"></i>
                                                Vérifier KYC
                                            </button>
                                            <button class="btn btn-outline-primary" data-section="transactions">
                                                <i class="bi bi-credit-card me-2"></i>
                                                Voir Transactions
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Users Section -->
                    <div id="users-section" class="content-section">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h3>Gestion des Utilisateurs</h3>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">
                                <i class="bi bi-person-plus me-2"></i>
                                Créer Utilisateur
                            </button>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <h5 class="mb-0">Liste des Utilisateurs</h5>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <input type="text" class="form-control" placeholder="Rechercher un utilisateur...">
                                            <button class="btn btn-outline-secondary" type="button">
                                                <i class="bi bi-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Nom</th>
                                                <th>Email</th>
                                                <th>Rôle</th>
                                                <th>Statut</th>
                                                <th>Date d'inscription</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersTableBody">
</tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card-footer">
                                <nav>
                                    <ul class="pagination justify-content-center mb-0">
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#">Précédent</a>
                                        </li>
                                        <li class="page-item active">
                                            <a class="page-link" href="#">1</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="#">2</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="#">3</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="#">Suivant</a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>

                    <!-- Agents Section -->
                    <div id="agents-section" class="content-section">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h3>Gestion des Agents</h3>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createAgentModal">
                                <i class="bi bi-person-badge me-2"></i>
                                Créer Agent
                            </button>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Liste des Agents</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Email</th>
                                                <th>Rôle</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="agentsTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Transactions Section -->
                    <div id="transactions-section" class="content-section">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h3>Gestion des Transactions</h3>
                            <div class="btn-group">
                                <button class="btn btn-outline-primary">
                                    <i class="bi bi-download me-2"></i>
                                    Exporter
                                </button>
                                <button class="btn btn-outline-primary">
                                    <i class="bi bi-funnel me-2"></i>
                                    Filtrer
                                </button>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <h5 class="mb-0">Transactions Récentes</h5>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <input type="text" class="form-control" placeholder="Rechercher une transaction..." id="txSearchInput">
                                            <button class="btn btn-outline-secondary" type="button">
                                                <i class="bi bi-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-6 mb-2">
                                        <select id="txFilterType" class="form-select">
                                            <option value="all">Tous les types</option>
                                            <option value="Dépôt">Dépôt</option>
                                            <option value="Retrait">Retrait</option>
                                            <option value="Trading">Trading</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <select id="txFilterStatus" class="form-select">
                                            <option value="all">Tous les statuts</option>
                                            <option value="complet">complet</option>
                                            <option value="En cours">En cours</option>
                                            <option value="reject">reject</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>Opération</th>
                                                <th>Utilisateur</th>
                                                <th>Type</th>
                                                <th>Montant</th>
                                                <th>Statut</th>
                                                <th>Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="transactionsTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- KYC Section -->
                    <div id="kyc-section" class="content-section">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h3>Vérification KYC</h3>
                            <div class="btn-group">
                                <button class="btn btn-outline-success">
                                    <i class="bi bi-check-circle me-2"></i>
                                    Approuver Tout
                                </button>
                                <button class="btn btn-outline-danger">
                                    <i class="bi bi-x-circle me-2"></i>
                                    Rejeter Sélectionnés
                                </button>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Demandes KYC en Attente</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>
                                                    <input type="checkbox" class="form-check-input">
                                                </th>
                                                <th>Utilisateur</th>
                                                <th>Type de Document</th>
                                                <th>Date de Soumission</th>
                                                <th>Statut</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <input type="checkbox" class="form-check-input">
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <img src="https://via.placeholder.com/40" class="rounded-circle me-2" alt="Avatar">
                                                        <div>
                                                            <div class="fw-bold">Pierre Dubois</div>
                                                            <small class="text-muted">pierre.dubois@email.com</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>Carte d'Identité</td>
                                                <td>23/06/2025</td>
                                                <td><span class="badge bg-warning">En Attente</span></td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal" data-bs-target="#kycModal">
                                                        <i class="bi bi-eye"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-success me-1">
                                                        <i class="bi bi-check"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <input type="checkbox" class="form-check-input">
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <img src="https://via.placeholder.com/40" class="rounded-circle me-2" alt="Avatar">
                                                        <div>
                                                            <div class="fw-bold">Claire Moreau</div>
                                                            <small class="text-muted">claire.moreau@email.com</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>Passeport</td>
                                                <td>22/06/2025</td>
                                                <td><span class="badge bg-warning">En Attente</span></td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal" data-bs-target="#kycModal">
                                                        <i class="bi bi-eye"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-success me-1">
                                                        <i class="bi bi-check"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Créer un Nouvel Utilisateur</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createUserForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName" class="form-label">Prénom</label>
                                <input type="text" class="form-control" id="firstName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName" class="form-label">Nom</label>
                                <input type="text" class="form-control" id="lastName" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="password" class="form-label">Mot de Passe</label>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="confirmPassword" class="form-label">Confirmer le Mot de Passe</label>
                                <input type="password" class="form-control" id="confirmPassword" required>
                            </div>
                        </div>
                        <!-- role field removed: user creation always creates a standard account -->
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="createUser()">Créer Utilisateur</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Agent Modal -->
    <div class="modal fade" id="createAgentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Créer un Nouvel Agent</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createAgentForm">
                        <div class="mb-3">
                            <label for="agentEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="agentEmail" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="agentPassword" class="form-label">Mot de Passe</label>
                                <input type="password" class="form-control" id="agentPassword" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="agentConfirm" class="form-label">Confirmer le Mot de Passe</label>
                                <input type="password" class="form-control" id="agentConfirm" required>
                            </div>
                        </div>
                        <div class="mb-3" id="agentRoleContainer" style="display: none;">
                            <label for="agentRole" class="form-label">Type de Compte</label>
                            <select class="form-select" id="agentRole">
                                <option value="0">Agent</option>
                                <option value="1">Administrateur</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="createAgent()">Créer Agent</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Agent Modal -->
    <div class="modal fade" id="editAgentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modifier Agent</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editAgentForm">
                        <input type="hidden" id="editAgentId">
                        <div class="mb-3">
                            <label for="editAgentEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="editAgentEmail">
                        </div>
                        <div class="mb-3">
                            <label for="editAgentRole" class="form-label">Type de Compte</label>
                            <select class="form-select" id="editAgentRole">
                                <option value="0">Agent</option>
                                <option value="1">Administrateur</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editAgentOldPassword" class="form-label">Ancien mot de passe</label>
                            <input type="password" class="form-control" id="editAgentOldPassword">
                        </div>
                        <div class="mb-3">
                            <label for="editAgentNewPassword" class="form-label">Nouveau mot de passe</label>
                            <input type="password" class="form-control" id="editAgentNewPassword">
                        </div>
                        <div class="mb-3">
                            <label for="editAgentConfirm" class="form-label">Confirmer le mot de passe</label>
                            <input type="password" class="form-control" id="editAgentConfirm">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="saveEditAgent">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- View User Modal -->
    <div class="modal fade" id="viewUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Détails Utilisateur</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Nom:</strong> <span id="viewFullName"></span></p>
                    <p><strong>Email:</strong> <span id="viewEmail"></span></p>
                    <p><strong>Date d'inscription:</strong> <span id="viewCreated"></span></p>
                    <div class="progress mb-3">
                        <div class="progress-bar" id="viewKycBar" role="progressbar" style="width:0%">0%</div>
                    </div>
                    <p><strong>KYC Status:</strong> <span id="viewKycLabel">pending</span></p>
                    <h6 class="mt-3">Dépôts récents</h6>
                    <table class="table table-sm">
                        <thead>
                            <tr><th>Date</th><th>Montant</th><th>Méthode</th><th>Statut</th></tr>
                        </thead>
                        <tbody id="viewDeposits"></tbody>
                    </table>
                    <h6 class="mt-3">Retraits récents</h6>
                    <table class="table table-sm">
                        <thead>
                            <tr><th>Date</th><th>Montant</th><th>Méthode</th><th>Statut</th></tr>
                        </thead>
                        <tbody id="viewWithdrawals"></tbody>
                    </table>
                    <h6 class="mt-3">Historique de Trading</h6>
                    <table class="table table-sm">
                        <thead>
                            <tr><th>Temps</th><th>Paire</th><th>Type</th><th>Montant</th><th>Prix</th><th>Statut</th><th>Profit/Perte</th></tr>
                        </thead>
                        <tbody id="viewTrading"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modifier Utilisateur</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div id="editUserFields" class="row g-3"></div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label for="editPassword" class="form-label">Nouveau mot de passe</label>
                                <input type="password" class="form-control" id="editPassword">
                            </div>
                            <div class="col-md-6">
                                <label for="editPasswordConfirm" class="form-label">Confirmer le mot de passe</label>
                                <input type="password" class="form-control" id="editPasswordConfirm">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="saveEditUser">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- KYC Details Modal -->
    <div class="modal fade" id="kycModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Détails de la Vérification KYC</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Informations Utilisateur</h6>
                            <p><strong>Nom:</strong> Pierre Dubois</p>
                            <p><strong>Email:</strong> pierre.dubois@email.com</p>
                            <p><strong>Date de naissance:</strong> 15/03/1985</p>
                            <p><strong>Adresse:</strong> 123 Rue de la Paix, Paris</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Documents Soumis</h6>
                            <div class="mb-3">
                                <img src="https://via.placeholder.com/200x120" class="img-fluid border rounded" alt="Document">
                                <p class="mt-2"><small>Carte d'Identité - Recto</small></p>
                            </div>
                            <div class="mb-3">
                                <img src="https://via.placeholder.com/200x120" class="img-fluid border rounded" alt="Document">
                                <p class="mt-2"><small>Carte d'Identité - Verso</small></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger">Rejeter</button>
                    <button type="button" class="btn btn-success">Approuver</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Settings Modal -->
    <div class="modal fade" id="adminSettingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Paramètres du Compte</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="adminSettingsForm">
                        <div class="mb-3">
                            <label class="form-label">ID</label>
                            <input type="text" class="form-control" id="settingsAdminId" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="settingsEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="settingsEmail">
                        </div>
                        <div class="mb-3">
                            <label for="settingsOldPassword" class="form-label">Ancien mot de passe</label>
                            <input type="password" class="form-control" id="settingsOldPassword">
                        </div>
                        <div class="mb-3">
                            <label for="settingsNewPassword" class="form-label">Nouveau mot de passe</label>
                            <input type="password" class="form-control" id="settingsNewPassword">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="button" class="btn btn-primary" id="saveAdminSettings">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Navigation functionality
        document.addEventListener('DOMContentLoaded', function() {
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            const sections = document.querySelectorAll('.content-section');
            
            // Handle navigation clicks
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all links
                    navLinks.forEach(l => l.classList.remove('active'));
                    
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    // Hide all sections
                    sections.forEach(section => section.classList.remove('active'));
                    
                    // Show target section
                    const targetSection = this.getAttribute('data-section');
                    document.getElementById(targetSection + '-section').classList.add('active');
                    if (targetSection === 'transactions') loadTransactions();
                });
            });
            
            // Handle quick action buttons
            document.querySelectorAll('[data-section]').forEach(button => {
                button.addEventListener('click', function() {
                    const targetSection = this.getAttribute('data-section');

                    // Update navigation
                    navLinks.forEach(l => l.classList.remove('active'));
                    document.querySelector(`[data-section="${targetSection}"]`).classList.add('active');

                    // Show target section
                    sections.forEach(section => section.classList.remove('active'));
                    document.getElementById(targetSection + '-section').classList.add('active');
                    if (targetSection === 'transactions') loadTransactions();
                });
            });
            checkAuth();
        });

        let ADMIN_ID = null;
        let ADMIN_EMAIL = '';
        let IS_ADMIN = 0;

        // Minimal MD5 implementation used to hash passwords client-side
        function md5(str) {
            function cmn(q, a, b, x, s, t) {
                a = (a + q + x + t) | 0;
                return (((a << s) | (a >>> (32 - s))) + b) | 0;
            }
            function ff(a, b, c, d, x, s, t) { return cmn((b & c) | (~b & d), a, b, x, s, t); }
            function gg(a, b, c, d, x, s, t) { return cmn((b & d) | (c & ~d), a, b, x, s, t); }
            function hh(a, b, c, d, x, s, t) { return cmn(b ^ c ^ d, a, b, x, s, t); }
            function ii(a, b, c, d, x, s, t) { return cmn(c ^ (b | ~d), a, b, x, s, t); }

            function md5cycle(x, k) {
                let a = x[0], b = x[1], c = x[2], d = x[3];
                a = ff(a, b, c, d, k[0], 7 , -680876936);
                d = ff(d, a, b, c, k[1], 12, -389564586);
                c = ff(c, d, a, b, k[2], 17,  606105819);
                b = ff(b, c, d, a, k[3], 22, -1044525330);
                a = ff(a, b, c, d, k[4], 7 , -176418897);
                d = ff(d, a, b, c, k[5], 12,  1200080426);
                c = ff(c, d, a, b, k[6], 17, -1473231341);
                b = ff(b, c, d, a, k[7], 22, -45705983);
                a = ff(a, b, c, d, k[8], 7 ,  1770035416);
                d = ff(d, a, b, c, k[9], 12, -1958414417);
                c = ff(c, d, a, b, k[10],17, -42063);
                b = ff(b, c, d, a, k[11],22, -1990404162);
                a = ff(a, b, c, d, k[12],7 ,  1804603682);
                d = ff(d, a, b, c, k[13],12, -40341101);
                c = ff(c, d, a, b, k[14],17, -1502002290);
                b = ff(b, c, d, a, k[15],22,  1236535329);

                a = gg(a, b, c, d, k[1], 5 , -165796510);
                d = gg(d, a, b, c, k[6], 9 , -1069501632);
                c = gg(c, d, a, b, k[11],14,  643717713);
                b = gg(b, c, d, a, k[0], 20, -373897302);
                a = gg(a, b, c, d, k[5], 5 , -701558691);
                d = gg(d, a, b, c, k[10],9 ,  38016083);
                c = gg(c, d, a, b, k[15],14, -660478335);
                b = gg(b, c, d, a, k[4], 20, -405537848);
                a = gg(a, b, c, d, k[9], 5 ,  568446438);
                d = gg(d, a, b, c, k[14],9 , -1019803690);
                c = gg(c, d, a, b, k[3], 14, -187363961);
                b = gg(b, c, d, a, k[8], 20,  1163531501);
                a = gg(a, b, c, d, k[13],5 , -1444681467);
                d = gg(d, a, b, c, k[2], 9 , -51403784);
                c = gg(c, d, a, b, k[7], 14,  1735328473);
                b = gg(b, c, d, a, k[12],20, -1926607734);

                a = hh(a, b, c, d, k[5], 4 , -378558);
                d = hh(d, a, b, c, k[8], 11, -2022574463);
                c = hh(c, d, a, b, k[11],16,  1839030562);
                b = hh(b, c, d, a, k[14],23, -35309556);
                a = hh(a, b, c, d, k[1], 4 , -1530992060);
                d = hh(d, a, b, c, k[4], 11,  1272893353);
                c = hh(c, d, a, b, k[7], 16, -155497632);
                b = hh(b, c, d, a, k[10],23, -1094730640);
                a = hh(a, b, c, d, k[13],4 ,  681279174);
                d = hh(d, a, b, c, k[0], 11, -358537222);
                c = hh(c, d, a, b, k[3], 16, -722521979);
                b = hh(b, c, d, a, k[6], 23,  76029189);
                a = hh(a, b, c, d, k[9], 4 , -640364487);
                d = hh(d, a, b, c, k[12],11, -421815835);
                c = hh(c, d, a, b, k[15],16,  530742520);
                b = hh(b, c, d, a, k[2], 23, -995338651);

                a = ii(a, b, c, d, k[0], 6 , -198630844);
                d = ii(d, a, b, c, k[7], 10,  1126891415);
                c = ii(c, d, a, b, k[14],15, -1416354905);
                b = ii(b, c, d, a, k[5], 21, -57434055);
                a = ii(a, b, c, d, k[12],6 ,  1700485571);
                d = ii(d, a, b, c, k[3], 10, -1894986606);
                c = ii(c, d, a, b, k[10],15, -1051523);
                b = ii(b, c, d, a, k[1], 21, -2054922799);
                a = ii(a, b, c, d, k[8], 6 ,  1873313359);
                d = ii(d, a, b, c, k[15],10, -30611744);
                c = ii(c, d, a, b, k[6], 15, -1560198380);
                b = ii(b, c, d, a, k[13],21,  1309151649);
                a = ii(a, b, c, d, k[4], 6 , -145523070);
                d = ii(d, a, b, c, k[11],10, -1120210379);
                c = ii(c, d, a, b, k[2], 15,  718787259);
                b = ii(b, c, d, a, k[9], 21, -343485551);

                x[0] = (a + x[0]) | 0;
                x[1] = (b + x[1]) | 0;
                x[2] = (c + x[2]) | 0;
                x[3] = (d + x[3]) | 0;
            }

            function md51(s) {
                const txt = unescape(encodeURIComponent(s));
                const n = txt.length;
                const state = [1732584193, -271733879, -1732584194, 271733878];
                for (let i = 64; i <= n; i += 64) {
                    md5cycle(state, md5blk(txt.substring(i - 64, i)));
                }
                let tail = new Array(16).fill(0);
                let i = 0;
                for (; i < n % 64; i++) {
                    tail[i >> 2] |= txt.charCodeAt(n - (n % 64) + i) << ((i % 4) << 3);
                }
                tail[i >> 2] |= 0x80 << ((i % 4) << 3);
                if (i > 55) {
                    md5cycle(state, tail);
                    tail = new Array(16).fill(0);
                }
                tail[14] = n * 8;
                md5cycle(state, tail);
                return state;
            }

            function md5blk(s) {
                const md5blks = [];
                for (let i = 0; i < 64; i += 4) {
                    md5blks[i >> 2] = s.charCodeAt(i) +
                        (s.charCodeAt(i + 1) << 8) +
                        (s.charCodeAt(i + 2) << 16) +
                        (s.charCodeAt(i + 3) << 24);
                }
                return md5blks;
            }

            function rhex(n) {
                let s = '';
                for (let j = 0; j < 4; j++) {
                    s += ((n >> (j * 8 + 4)) & 0x0f).toString(16) +
                        ((n >> (j * 8)) & 0x0f).toString(16);
                }
                return s;
            }

            function hex(x) { return x.map(rhex).join(''); }

            return hex(md51(str));
        }

        function fetchWithAuth(url, options = {}) {
            options.headers = options.headers || {};
            if (ADMIN_ID) options.headers['Authorization'] = 'Bearer ' + ADMIN_ID;
            return fetch(url, options);
        }

        async function checkAuth() {
            try {
                const res = await fetchWithAuth('admin_getter.php');
                if (!res.ok) throw new Error('unauthorized');
                const data = await res.json();
                if (data.admin_id) ADMIN_ID = data.admin_id;
                if (data.email) ADMIN_EMAIL = data.email;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboardContainer').style.display = 'block';
                loadAdminData();
            } catch (err) {
                document.getElementById('dashboardContainer').style.display = 'none';
                document.getElementById('loginSection').style.display = 'block';
            }
        }

        document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const pwd = document.getElementById('loginPassword').value;
            const formData = new FormData();
            formData.append('email', email);
            formData.append('password', md5(pwd));
            const res = await fetch('admin_login.php', { method: 'POST', body: formData });
            const result = await res.json();
            if (result.status === 'ok') {
                if (result.admin_id) ADMIN_ID = result.admin_id;
                checkAuth();
            } else {
                alert('Échec de la connexion');
            }
        });

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/'/g, '&#39;')
                .replace(/"/g, '&quot;');
        }

        function formatDollar(num) {
            const n = Number(num);
            const hasDecimals = n % 1 !== 0;
            return n.toLocaleString('en-US', {
                minimumFractionDigits: hasDecimals ? 2 : 0,
                maximumFractionDigits: hasDecimals ? 2 : 0
            }) + ' $';
        }

        async function loadAdminData() {
            try {
                const res = await fetchWithAuth('admin_getter.php');
                const data = await res.json();
                if (data.admin_id) ADMIN_ID = data.admin_id;
                if (data.email) ADMIN_EMAIL = data.email;
                IS_ADMIN = parseInt(data.is_admin || 0);

                if (data.stats) {
                    document.getElementById('statTotalUsers').textContent = data.stats.total_users;
                    document.getElementById('statTotalDeposits').textContent =
                        Number(data.stats.total_deposits).toLocaleString('en-US', {minimumFractionDigits: 2}) + ' $';
                    document.getElementById('statDepositCount').textContent = data.stats.deposit_count || 0;
                    document.getElementById('statSuccessRate').textContent =
                        (data.stats.success_rate || 0) + '%';
                }

                document.getElementById('agentsNavItem').style.display = IS_ADMIN ? 'block' : 'none';
                const quickBtn = document.getElementById('createAgentQuickBtn');
                if (quickBtn) quickBtn.style.display = IS_ADMIN ? 'block' : 'none';
                const roleContainer = document.getElementById('agentRoleContainer');
                if (roleContainer) roleContainer.style.display = IS_ADMIN ? 'block' : 'none';

                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';
                const users = data.users || [];
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Aucune donnée disponible</td></tr>';
                } else {
                    users.forEach(u => {
                        const row = `<tr>
                            <td>${escapeHtml(u.user_id)}</td>
                            <td>${escapeHtml(u.fullName || '')}</td>
                            <td>${escapeHtml(u.emailaddress || '')}</td>
                            <td><span class="badge bg-primary">Utilisateur</span></td>
                            <td><span class="badge bg-success">Actif</span></td>
                            <td>${escapeHtml(u.created_at || '')}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary me-1 user-view" data-id="${escapeHtml(u.user_id)}"><i class="fas fa-eye"></i></button>
                                <button class="btn btn-sm btn-outline-primary me-1 user-edit" data-id="${escapeHtml(u.user_id)}"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-outline-danger user-delete" data-id="${escapeHtml(u.user_id)}"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                        tbody.insertAdjacentHTML('beforeend', row);
                    });
                }

                const agentsBody = document.getElementById('agentsTableBody');
                if (agentsBody) {
                    agentsBody.innerHTML = '';
                    const agents = data.agents || [];
                    window.AGENTS = agents;
                    if (agents.length === 0) {
                        agentsBody.innerHTML = '<tr><td colspan="4" class="text-center">Aucune donnée disponible</td></tr>';
                    } else {
                        agents.forEach(a => {
                            const roleBadge = parseInt(a.is_admin) === 1 ?
                                '<span class="badge bg-primary">Admin</span>' :
                                '<span class="badge bg-secondary">Agent</span>';
                            const row = `<tr data-id="${escapeHtml(a.id)}">
                                <td>${escapeHtml(a.id)}</td>
                                <td>${escapeHtml(a.email)}</td>
                                <td>${roleBadge}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1 agent-edit" data-id="${escapeHtml(a.id)}"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-outline-danger agent-delete" data-id="${escapeHtml(a.id)}"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>`;
                            agentsBody.insertAdjacentHTML('beforeend', row);
                        });
                    }
                }
                loadTransactions();
            } catch (err) {
                console.error('Failed to load admin data', err);
            }
        }

        // Create user functionality
        async function createUser() {
            const form = document.getElementById('createUserForm');

            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (password !== confirmPassword) {
                alert('Les mots de passe ne correspondent pas!');
                return;
            }

            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();

            const payload = {
                action: 'create_user',
                user: {
                    user_id: Date.now(),
                    fullName: firstName + ' ' + lastName,
                    emailaddress: email,
                    password: md5(password),
                    linked_to_id: ADMIN_ID
                }
            };

            try {
                const res = await fetchWithAuth('admin_setter.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                if (result.status === 'ok') {
                    alert('Utilisateur créé avec succès!');
                    form.reset();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createUserModal'));
                    modal.hide();
                    loadAdminData();
                } else {
                    alert('Erreur lors de la création');
                }
            } catch (err) {
                console.error('Creation failed', err);
                alert('Erreur lors de la création');
            }
        }

        async function createAgent() {
            const email = document.getElementById('agentEmail').value.trim();
            const pass = document.getElementById('agentPassword').value;
            const confirm = document.getElementById('agentConfirm').value;
            if (pass !== confirm) {
                alert('Les mots de passe ne correspondent pas!');
                return;
            }
            const roleSelect = document.getElementById('agentRole');
            const isAdminVal = roleSelect ? parseInt(roleSelect.value || '0') : 0;
            const payload = {
                action: 'create_admin',
                email: email,
                password: md5(pass),
                is_admin: isAdminVal,
                created_by: ADMIN_ID
            };
            try {
                const res = await fetchWithAuth('admin_setter.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                if (result.status === 'ok') {
                    alert('Agent créé avec succès!');
                    document.getElementById('createAgentForm').reset();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createAgentModal'));
                    modal.hide();
                    loadAdminData();
                } else {
                    alert('Erreur lors de la création');
                }
            } catch (err) {
                console.error('Creation failed', err);
                alert('Erreur lors de la création');
            }
        }

        // User table actions
        document.getElementById('usersTableBody').addEventListener('click', async function(e) {
            const viewBtn = e.target.closest('.user-view');
            const editBtn = e.target.closest('.user-edit');
            const delBtn = e.target.closest('.user-delete');
            if (viewBtn) {
                const id = viewBtn.getAttribute('data-id');
                const res = await fetchWithAuth('getter.php?user_id=' + id);
                const data = await res.json();
                const pd = data.personalData || {};
                document.getElementById('viewFullName').textContent = pd.fullName || '';
                document.getElementById('viewEmail').textContent = pd.emailaddress || '';
                document.getElementById('viewCreated').textContent = pd.created_at || '';
                const steps = Object.values(data.defaultKYCStatus || {});
                const completed = steps.filter(s => String(s.status) === '1').length;
                const pct = Math.round((completed / steps.length) * 100);
                const bar = document.getElementById('viewKycBar');
                bar.style.width = pct + '%';
                bar.textContent = pct + '%';
                bar.classList.remove('bg-success','bg-warning');
                bar.classList.add(pct === 100 ? 'bg-success' : 'bg-warning');
                document.getElementById('viewKycLabel').textContent = pct === 100 ? 'completed' : 'pending';
                const depBody = document.getElementById('viewDeposits');
                depBody.innerHTML = '';
                (data.deposits || []).slice(0,10).forEach(d => {
                    depBody.insertAdjacentHTML('beforeend', `<tr><td>${escapeHtml(d.date)}</td><td>${formatDollar(d.amount)}</td><td>${escapeHtml(d.method)}</td><td><span class="badge ${escapeHtml(d.statusClass)}">${escapeHtml(d.status)}</span></td></tr>`);
                });
                if (!depBody.innerHTML) depBody.innerHTML = '<tr><td colspan="4" class="text-center">Aucune donnée</td></tr>';
                const witBody = document.getElementById('viewWithdrawals');
                witBody.innerHTML = '';
                (data.retraits || []).slice(0,10).forEach(r => {
                    witBody.insertAdjacentHTML('beforeend', `<tr><td>${escapeHtml(r.date)}</td><td>${formatDollar(r.amount)}</td><td>${escapeHtml(r.method)}</td><td><span class="badge ${escapeHtml(r.statusClass)}">${escapeHtml(r.status)}</span></td></tr>`);
                });
                if (!witBody.innerHTML) witBody.innerHTML = '<tr><td colspan="4" class="text-center">Aucune donnée</td></tr>';
                const tradeBody = document.getElementById('viewTrading');
                tradeBody.innerHTML = '';
                (data.tradingHistory || []).slice(0,10).forEach(t => {
                    const profit = t.profitPerte == null ? '-' : formatDollar(t.profitPerte);
                    tradeBody.insertAdjacentHTML('beforeend', `<tr><td>${escapeHtml(t.temps)}</td><td>${escapeHtml(t.paireDevises)}</td><td><span class="badge ${escapeHtml(t.statutTypeClass)}">${escapeHtml(t.type)}</span></td><td>${formatDollar(t.montant)}</td><td>${formatDollar(t.prix)}</td><td><span class="badge ${escapeHtml(t.statutClass)}">${escapeHtml(t.statut)}</span></td><td class="${escapeHtml(t.profitClass || '')}">${profit}</td></tr>`);
                });
                if (!tradeBody.innerHTML) tradeBody.innerHTML = '<tr><td colspan="7" class="text-center">Aucune donnée</td></tr>';
                new bootstrap.Modal(document.getElementById('viewUserModal')).show();
            } else if (editBtn) {
                const id = editBtn.getAttribute('data-id');
                const res = await fetchWithAuth('getter.php?user_id=' + id);
                const data = await res.json();
                const pd = data.personalData || {};
                document.getElementById('editUserId').value = id;
                const container = document.getElementById('editUserFields');
                container.innerHTML = '';
                const hiddenFields = ['compteverifie','compteverifie01','niveauavance','passwordStrength','passwordStrengthBar','passwordHash'];
                Object.keys(pd).forEach(key => {
                    if (key === 'user_id' || hiddenFields.includes(key)) return;
                    const val = pd[key] == null ? '' : pd[key];
                    container.insertAdjacentHTML('beforeend', `<div class="col-md-6"><label class="form-label" for="edit_${escapeHtml(key)}">${escapeHtml(key)}</label><input type="text" class="form-control" id="edit_${escapeHtml(key)}" name="${escapeHtml(key)}" value="${escapeHtml(val)}"></div>`);
                });
                document.getElementById('editPassword').value = '';
                document.getElementById('editPasswordConfirm').value = '';
                new bootstrap.Modal(document.getElementById('editUserModal')).show();
            } else if (delBtn) {
                const id = delBtn.getAttribute('data-id');
                if (confirm('Supprimer cet utilisateur ?')) {
                    await fetchWithAuth('admin_setter.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'delete_user', user_id: id })
                    });
                    loadAdminData();
                }
            }
        });

        document.getElementById('saveEditUser').addEventListener('click', async function() {
            const id = document.getElementById('editUserId').value;
            const form = document.getElementById('editUserForm');
            const inputs = form.querySelectorAll('[name]');
            const user = { user_id: id };
            inputs.forEach(i => { user[i.name] = i.value; });
            const newPwd = document.getElementById('editPassword').value;
            const confirmPwd = document.getElementById('editPasswordConfirm').value;
            if (newPwd !== '') {
                if (newPwd !== confirmPwd) {
                    alert('Les mots de passe ne correspondent pas!');
                    return;
                }
                user.passwordHash = md5(newPwd);
            }
            const res = await fetchWithAuth('admin_setter.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'update_user', user: user })
            });
            let result;
            const txt = await res.text();
            try {
                result = JSON.parse(txt);
            } catch (err) {
                console.error('Invalid JSON', txt);
                alert('Erreur serveur');
                return;
            }
            if (result.status === 'ok') {
                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                loadAdminData();
            } else {
                alert('Erreur lors de la mise à jour');
            }
        });

        // Agent table actions
        const agentsTable = document.getElementById('agentsTableBody');
        if (agentsTable) {
            agentsTable.addEventListener('click', async function(e) {
                const editBtn = e.target.closest('.agent-edit');
                const delBtn = e.target.closest('.agent-delete');
                if (editBtn) {
                    const id = editBtn.getAttribute('data-id');
                    const agent = (window.AGENTS || []).find(a => String(a.id) === String(id));
                    if (!agent) return;
                    document.getElementById('editAgentId').value = agent.id;
                    document.getElementById('editAgentEmail').value = agent.email || '';
                    document.getElementById('editAgentRole').value = agent.is_admin || '0';
                    document.getElementById('editAgentOldPassword').value = '';
                    document.getElementById('editAgentNewPassword').value = '';
                    document.getElementById('editAgentConfirm').value = '';
                    new bootstrap.Modal(document.getElementById('editAgentModal')).show();
                } else if (delBtn) {
                    const id = delBtn.getAttribute('data-id');
                    if (confirm('Supprimer cet agent ?')) {
                        await fetchWithAuth('admin_setter.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'delete_admin', id: id })
                        });
                        loadAdminData();
                    }
                }
            });
        }

        document.getElementById('saveEditAgent').addEventListener('click', async function() {
            const id = document.getElementById('editAgentId').value;
            const email = document.getElementById('editAgentEmail').value.trim();
            const role = document.getElementById('editAgentRole').value;
            const oldPwd = document.getElementById('editAgentOldPassword').value;
            const newPwd = document.getElementById('editAgentNewPassword').value;
            const confirm = document.getElementById('editAgentConfirm').value;
            const payload = { action: 'update_admin', id: id, email: email, is_admin: parseInt(role) };
            if (newPwd !== '') {
                if (newPwd !== confirm) {
                    alert('Les mots de passe ne correspondent pas!');
                    return;
                }
                if (oldPwd === '') {
                    alert('Ancien mot de passe requis');
                    return;
                }
                payload.old_password = md5(oldPwd);
                payload.password = md5(newPwd);
            }
            const res = await fetchWithAuth('admin_setter.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            if (result.status === 'ok') {
                bootstrap.Modal.getInstance(document.getElementById('editAgentModal')).hide();
                loadAdminData();
            } else {
                alert('Erreur lors de la mise à jour');
            }
        });

        document.getElementById('logoutLink').addEventListener('click', async function(e) {
            e.preventDefault();
            await fetchWithAuth('admin_logout.php', { method: 'POST' });
            ADMIN_ID = null;
            ADMIN_EMAIL = '';
            document.getElementById('dashboardContainer').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
        });

        document.getElementById('settingsLink').addEventListener('click', async function(e) {
            e.preventDefault();
            document.getElementById('settingsAdminId').value = ADMIN_ID || '';
            document.getElementById('settingsEmail').value = ADMIN_EMAIL || '';
            document.getElementById('settingsOldPassword').value = '';
            document.getElementById('settingsNewPassword').value = '';
            new bootstrap.Modal(document.getElementById('adminSettingsModal')).show();
        });

        document.getElementById('saveAdminSettings').addEventListener('click', async function() {
            const email = document.getElementById('settingsEmail').value.trim();
            const oldPwd = document.getElementById('settingsOldPassword').value;
            const newPwd = document.getElementById('settingsNewPassword').value;
            const payload = { action: 'update_admin', id: ADMIN_ID, email: email };
            if (newPwd !== '') {
                if (oldPwd === '') {
                    alert('Ancien mot de passe requis');
                    return;
                }
                payload.old_password = md5(oldPwd);
                payload.password = md5(newPwd);
            }
            const res = await fetchWithAuth('admin_setter.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            if (result.status === 'ok') {
                ADMIN_EMAIL = email;
                bootstrap.Modal.getInstance(document.getElementById('adminSettingsModal')).hide();
            } else {
                alert(result.message || 'Erreur lors de la mise à jour');
            }
        });


        let ALL_TXS = [];

        function renderTransactions() {
            const tbody = document.getElementById('transactionsTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            const typeClasses = {
                'Retrait': 'bg-warning',
                'Dépôt': 'bg-info',
                'Trading': 'bg-primary'
            };

            const typeSel = document.getElementById('txFilterType');
            const statusSel = document.getElementById('txFilterStatus');
            const searchInput = document.getElementById('txSearchInput');
            const typeVal = typeSel ? typeSel.value : 'all';
            const statusVal = statusSel ? statusSel.value : 'all';
            const searchVal = searchInput ? searchInput.value.trim().toLowerCase() : '';

            let txs = ALL_TXS.slice();
            if (typeVal !== 'all') txs = txs.filter(t => String(t.type).toLowerCase() === typeVal.toLowerCase());
            if (statusVal !== 'all') txs = txs.filter(t => String(t.status).toLowerCase() === statusVal.toLowerCase());
            if (searchVal) txs = txs.filter(t => String(t.operationNumber).toLowerCase().includes(searchVal));

            if (txs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Aucune donnée disponible</td></tr>';
                return;
            }

            txs.forEach(t => {
                const normalizedStatus = String(t.status)
                    .trim()
                    .replace(/[\s.]+$/, '')
                    .toLowerCase();
                const hideAccept = normalizedStatus === 'complet';
                const row = `<tr data-id="${escapeHtml(t.operationNumber)}">`
                    + `<td>${escapeHtml(t.operationNumber)}</td>`
                    + `<td>${escapeHtml(t.user_id)}</td>`
                    + `<td><span class="badge ${escapeHtml(typeClasses[t.type] || 'bg-secondary')}">${escapeHtml(t.type || '')}</span></td>`
                    + `<td>${escapeHtml(t.amount || '')}</td>`
                    + `<td><span class="badge ${escapeHtml(t.statusClass || 'bg-secondary')}">${escapeHtml(t.status || '')}</span></td>`
                    + `<td>${escapeHtml(t.date || '')}</td>`
                    + `<td>`
                    + `<button class="btn btn-sm btn-outline-success me-1 tx-accept" ${hideAccept ? 'style=display:none;' : ''}>complet</button>`
                    + `<button class="btn btn-sm btn-outline-danger me-1 tx-reject">reject</button>`
                    + `<button class="btn btn-sm btn-outline-secondary tx-remove">remove</button>`
                    + `</td>`
                    + `</tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        async function loadTransactions() {
            try {
                const res = await fetchWithAuth('admin_transactions_getter.php');
                const data = await res.json();
                ALL_TXS = data.transactions || [];
                renderTransactions();
            } catch (err) {
                console.error('Failed to load transactions', err);
            }
        }
        async function updateTransaction(id, status, statusClass, remove = false) {
            const payload = { action: 'update_transaction', id: id };
            if (remove) {
                payload.delete = 1;
            } else {
                payload.status = status;
                payload.statusClass = statusClass;
            }
            await fetchWithAuth('admin_setter.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            loadTransactions();
        }

        const txBody = document.getElementById('transactionsTableBody');
        if (txBody) {
            txBody.addEventListener('click', function(e) {
                const id = e.target.closest('tr')?.getAttribute('data-id');
                if (!id) return;
                if (e.target.closest('.tx-accept')) {
                    updateTransaction(id, 'complet', 'bg-success');
                } else if (e.target.closest('.tx-reject')) {
                    updateTransaction(id, 'reject', 'bg-danger');
                } else if (e.target.closest('.tx-remove')) {
                    if (confirm('Supprimer cette transaction ?')) {
                        updateTransaction(id, '', '', true);
                    }
                }
            });
        }
       const typeSel = document.getElementById('txFilterType');
       const statusSel = document.getElementById('txFilterStatus');
        const searchInput = document.getElementById('txSearchInput');
       if (typeSel) typeSel.addEventListener('change', renderTransactions);
       if (statusSel) statusSel.addEventListener('change', renderTransactions);
        if (searchInput) searchInput.addEventListener('input', renderTransactions);

        // Add some interactive features
        document.addEventListener('DOMContentLoaded', function() {
            // Animate stats cards on load
            const statsCards = document.querySelectorAll('.stats-card');
            statsCards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(20px)';
                    card.style.transition = 'all 0.5s ease';
                    
                    setTimeout(() => {
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, 100);
                }, index * 100);
            });
        });
    </script>
</body>
</html>

